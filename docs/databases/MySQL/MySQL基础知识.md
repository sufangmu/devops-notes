# MySQL基础知识

## 一、SQL语句的执行过程

### 1. 连接层

1. 提供连接协议：TCP/IP，SOCKET
2. 提供验证：用户、密码、IP、SOCKET
3. 提供专用连接线程：接收用户SQL，返回结果

### 2. SQL层

1. 接收上层传送的SQL语句
2. 语法验证
3. 语义检查：判断SQL语句的类型
4. 权限检查：用户对库、表有没有权限
5. 解析器：进行SQL预处理，产生执行计划
6. 优化器：根据解析器得出的多种执行计划进行判断，选择最优的执行计划代价模式
7. 执行器：根据最优执行计划，执行SQL语句，产生执行结果
8. 提供查询缓存（默认不开启）
9. 提供日志记录（默认不开启）

### 3. 存储引擎层

负责根据SQL层执行的结果，从磁盘上拿数据

## 二、MySQL的逻辑结构

### 1. 库

### 2. 表

## 三、MySQL的物理结构

### 1. 库

用文件系统的目录来存储

```bash
root@gp:/data/mysql# tree -FL 1
.
├── auto.cnf
├── ca-key.pem
├── ca.pem
├── client-cert.pem
├── client-key.pem
├── gp.err
├── ib_buffer_pool
├── ibdata1
├── ib_logfile0
├── ib_logfile1
├── mysql/
├── performance_schema/
├── private_key.pem
├── public_key.pem
├── server-cert.pem
├── server-key.pem
└── sys/

```

### 2. 表

#### 2.1 MYISAM表的存储

```bash
root@gp:/data/mysql/mysql# ls user.* -lF
-rw-r----- 1 mysql mysql 10816 Apr 18 22:15 user.frm # 存储列信息
-rw-r----- 1 mysql mysql   384 Apr 18 23:07 user.MYD # 存储数据行
-rw-r----- 1 mysql mysql  4096 Apr 18 23:26 user.MYI # 存储索引

```

#### 2.2 InnoDB表的存储

```bash
root@gp:/data/mysql/mysql# ls time_zone.* -l
-rw-r----- 1 mysql mysql  8636 Apr 18 22:15 time_zone.frm # 存储列信息
-rw-r----- 1 mysql mysql 98304 Apr 18 22:15 time_zone.ibd # 存数据和索引
```

## 四、数据类型

### 1. 整数类型

mysql中整数型数据类型

| 类型名称  | 存储需求 | 有符号                                      | 无符号                   |
| :-------: | :------: | ------------------------------------------- | ------------------------ |
|  TINYINT  | 1个字节  | -128 ~ 127                                  | 0 ~ 255                  |
| SMALLINT  | 2个字节  | -32768 ~ 32767                              | 0 ~ 65535                |
| MEDIUMINT | 3个字节  | -8388608 ~ 8388607                          | 0 ~ 16777215             |
|    INT    | 4个字节  | -2147483648  ~ 2147483647                   | 0 ~ 4294967295           |
|  BIGINT   | 8个字节  | -9223372036854775808 ~ 92233720368547758077 | 0 ~ 18446744073709551615 |

### 2. 浮点数类型和定点数类型

| 类型名称          | 存储需求  | 无符号                                               | 有符号                                              |
| ----------------- | --------- | ---------------------------------------------------- | --------------------------------------------------- |
| FLOAT             | 4个字节   | 0和1.175494351E-38 ~ 3.402823466E+38                 | -3.402823466E+38 ~ -1.175494351E-38                 |
| DOUBLE            | 8个字节   | 0和2.2250738585072014E-308 ~ 1.7976931348623157E+308 | -1.7976931348623157E+308 ~ -2.2250738585072014E-308 |
| DECIMAL(M,D), DEC | M+2个字节 | 同DOUBLE                                             | 同DOUBLE                                            |

M：精度，表示总共的位数

N：标度，小数的位数

DECIMAL是以字符串的形式存放的，默认精度为(10,0)，在对精度要求较高的时候，建议使用DECIMAL。

### 3. 日期和时间

| 类型名称  | 日期格式                       | 日期范围                                                |
| --------- | ------------------------------ | ------------------------------------------------------- |
| YEAR      | YYYY                           | 1901 ~ 2155                                             |
| TIME      | HH:MM:SS[.fraction]            | -838:59:59.000000 ~ 838:59:59.000000                    |
| DATE      | YYYY-MM-DD                     | 1000-01-01 ~ 9999-12-31                                 |
| DATETIME  | YYYY-MM-DD HH:MM:SS[.fraction] | 1000-01-01 00:00:00.000000 ~ 9999-12-31 23:59:59.999999 |
| TIMESTAMP | YYYYMMDDHHMMSS                 | 1970-01-01 00:00:01.000000 ~ 2038-01-19 03:14:07.999999 |

### 4. 文本字符串类型

| 类型名称   | 存储需求                                             |
| ---------- | ---------------------------------------------------- |
| CHAR(M)    | M字节,1<=M<=255（M表示列长度）                       |
| VARCHAR(M) | L+1字节，L<=M，1<=M<=65535                           |
| TINYTEXT   | L+1字节，L<2^8                                       |
| TEXT       | L+2字节，L<2^16                                      |
| MEDIUMTEXT | L+3字节，L<2^24                                      |
| LONGTEXT   | L+4字节，L<2^32                                      |
| ENUM       | 1或2个字节，取决于枚举值的数据(最大值65535)          |
| SET        | 1,2,3,4或8个字节，取决于集合成员的数量(最多64个成员) |

L：列值的实际长度

### 5. 二进制字符串

| 类型名称     |                                            | 存储需求          |
| ------------ | ------------------------------------------ | ----------------- |
| BIT(M)       | M位二进制数，最大值为64，默认为1           | 大约(M+7)/8个字节 |
| BINARY(M)    | 字节数为M，允许长度为0-M的定长二进制字符串 | M个字节           |
| VARBINARY(M) | 允许长度为0-M的变长二进制字符串            | M+1个字节         |
| TINYBLOB     | 可边长二进制数据，最多255个字节            | L+1字节，L<2^8    |
| BLOB         | 可边长二进制数据，最多2^16-1个字节         | L+2字节，L<2^16   |
| MEDIUMBLOB   | 可边长二进制数据，最多2^24-1个字节         | L+3字节，L<2^24   |
| LONGBLOB     | 可边长二进制数据，最多2^32-1个字节         | L+4字节，L<2^32   |

数据类型的选择：

1. 如果要对小数进行数值比较，最好用DECIMAL
2. float(M,D)是非标准SQL定义，尽量不要使用

3. 对于存储不大，但在速度上有要求的用CHAR，反之用VARCHAR

## 五、表属性

### 1. 列的属性

常用约束：一般建表时加

```
PRIMARY KEY：主键约束，主键在一个表中只能有一个
NOT NULL：非空约束，列值不能为空
UNIQUE KEY：唯一键
UNSIGNED：无符号，针对数字列
```

其他属性：根据需要后期加

```
KEY：索引
DEFAULT：默认值
AUTO_INCREMENT：针对数字列，顺序的自动填充数据（默认从1开始）
COMMENT：注释
```

### 2. 表的属性

1. 存储引擎：InnoDB（默认值）

2. 字符集：utf8

### 3. 字符集和校对规则

#### 3.1 字符集

1. utf8
2. utf8mb4：支持emoji

#### 3.2 校对规则（排序规则）

大小写是否敏感

## 六、视图库

存放了一些元数据

### 1. information_schema

#### 1.1 TABLES表

数据库中表的属性

例1：查询整个数据库中所有库和对应的表信息

```mysql
SELECT TABLE_SCHEMA, GROUP_CONCAT(TABLE_NAME)
FROM information_schema.TABLES
GROUP BY TABLE_SCHEMA;
```

例2：统计所有库下表的个数

```mysql
SELECT TABLE_SCHEMA, COUNT(TABLE_NAME)
FROM information_schema.TABLES
GROUP BY TABLE_SCHEMA;
```

例3：查询所有InnoDB引擎的表及所在库

```mysql
SELECT TABLE_SCHEMA, TABLE_NAME, ENGINE
FROM information_schema.`TABLES`
WHERE `ENGINE`='innoDB';
```

例4：统计world库下每张表的磁盘空间占用

```mysql
SELECT table_schema, table_name, TABLE_ROWS*AVG_ROW_LENGTH+INDEX_LENGTH
FROM information_schema.TABLES
WHERE TABLE_SCHEMA='world;
```

例5：统计所有数据库的总的磁盘占用

```mysql
SELECT table_schema, table_name, TABLE_ROWS*AVG_ROW_LENGTH+INDEX_LENGTH
FROM information_schema.TABLES;
```

## 七、索引

索引是一个单独的、存在磁盘上的数据库结构，它们包含着对数据表里所有记录的引用指针。

### 1. 索引作用

提供了类似于书中目录的作用，目的是为了简化查询

### 2. 索引的种类

#### 2.1 按算法分

1. B树索引
2. Hash索引
3. R树
4. Full text
5. GIS 

![](../../assets/images/Btree.jpg)

#### 2.2 按功能分

##### 2.2.1 聚簇索引

##### 2.2.2 辅助索引（二级索引）

辅助索引和 聚簇索引的区别

1.  聚簇索引只能有一个，非空唯一，一般是主键
2. 辅助索引可以有多个，是配合聚簇索引使用的
3. 聚簇索引叶节点就是磁盘数据行存储的数据页
4. MySQL根据聚簇索引组织存储结构，数据存储时就是按照聚簇索引的顺序进行存储数据
5. 辅助索引只会提取索引键值进行自动排序生成B树

### 3. 辅助索引的分类

#### 3.1 普通索引

基本索引类型，允许在定义索引的列中插入重复值和空值，其作用只是加快数据的访问速度。

#### 3.2 唯一索引

索引列的值必须唯一，可以允许有空值，可以减少查询索引列操作的时间，尤其是对比较庞大的数据表

#### 3.3 单列索引

一个索引只包含单个列，一个表可以有多个单列索引

#### 3.4 组合索引

在表的多个字段上组个创建索引，只有在查询条件中使用了这些字段的左边字段时，索引才会被使用

### 4. 索引树高度的影响因素

1. 数据量级，解决方法：分库，分表，分布式
2. 索引列值过长，解决方法：前缀索引
3. 数据类型

