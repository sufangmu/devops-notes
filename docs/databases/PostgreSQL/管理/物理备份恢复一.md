## 备份和恢复目的

保护数据库免受多种类型的故障
增加平均故障间隔时间(MTBF)
减少平均恢复时间(MTTR)
最小化数据丢失

## 故障类别

语句失败
用户进程失败
用户错误
网络故障
实例失败
介质故障
声明失败的原因
应用程序中的逻辑错误
试图在表中输入无效数据
尝试权限不足的操作
试图创建表，但超出了分配的配额限制
尝试对表执行INSERT或UPDATE操作，导致分配扩展数据块，但可用空间不足



## 声明失败的解决方案

纠正程序的逻辑流程
修改并重新发布SQL语句
提供必要的数据库权限
向数据库添加文件空间



## 用户进程失败的原因

用户在会话中执行了异常断开连接
用户的会话异常终止
用户的程序引发了地址异常，从而终止了会话


## 用户进程失败解决方案

postgres进程检测异常终止的用户进程
postgres回滚事务并释放其持有的所有资源和锁



## 用户可能的失误

```sql
SQL> DROP TABLE employees;

SQL> TRUNCATE TABLE employees;

SQL> DELETE FROM employees;

SQL> COMMIT;

SQL> UPDATE employees

2> SET salary = salary * 1.5;

SQL> COMMIT;
```


## 用户失误解决方案

培训数据库用户
从有效备份恢复
从导出文件导入表
使用WalMiner确定错误时间，使用时间点恢复进行恢复
使用WalMiner执行对象级恢复



## 实例失败的原因

断电
操作系统bug
数据库系统bug
后台进程意外kill


## 实例失败解决方案

不需要DBA采取特殊的恢复操作
启动实例
等待“数据库打开”通知
通知用户
检查警报日志以确定故障原因


## 介质失败的原因

磁盘驱动器上的磁头损坏
读取或写入数据库文件时出现物理问题
文件被意外删除

## 介质失败解决方案

恢复策略取决于选择的备份方法和受影响的文件
如果可用，请应用存档的重做日志文件以恢复自上次备份以来提交的数据


## 制定一个备份策略

业务要求
操作要求
技术注意事项
管理层同意



### 1.业务要求

平均恢复时间：决定备份的频率
平均无故障时间：缩短恢复时间
进化过程：根据实际情况，不断调整策略，比如：索引表空间的备份等等。

### 2.操作要求

24小时运营
测试和验证备份可用性
数据库波动性

### 3.技术考虑因素

资源：硬件、软件、人力和时间
操作系统文件的物理映像副本
数据库中对象的逻辑副本
数据库配置
影响所需备份频率的事务量



## 灾难恢复问题

如果发生重大灾难，如：
- 地震、洪水或火灾
- 机器完全丢失
- 存储硬件或软件故障
- 失去关键人员例如数据库管理员
